-- STEP 1: Create the database
DROP DATABASE IF EXISTS BANK;
CREATE DATABASE BANK;
USE BANK;

-- STEP 2: Create all required tables

CREATE TABLE BRANCH (
  BNAME VARCHAR(20) PRIMARY KEY,
  CITY VARCHAR(20),
  ASSETS REAL
);

CREATE TABLE ACCOUNT (
  ACCNO INT PRIMARY KEY,
  BNAME VARCHAR(20),
  BALANCE REAL,
  FOREIGN KEY (BNAME) REFERENCES BRANCH(BNAME)
);

CREATE TABLE CUST (
  CNAME VARCHAR(20) PRIMARY KEY,
  CSTREET VARCHAR(50) NOT NULL,
  CITY VARCHAR(20) NOT NULL
);

CREATE TABLE DEPOSITOR (
  CNAME VARCHAR(20),
  ACCNO INT,
  PRIMARY KEY (CNAME, ACCNO),
  FOREIGN KEY (ACCNO) REFERENCES ACCOUNT(ACCNO) ON DELETE CASCADE,
  FOREIGN KEY (CNAME) REFERENCES CUST(CNAME) ON DELETE CASCADE
);

CREATE TABLE LOAN (
  LNO INT PRIMARY KEY,
  BNAME VARCHAR(20) NOT NULL,
  AMT REAL,
  FOREIGN KEY (BNAME) REFERENCES BRANCH(BNAME) ON DELETE CASCADE
);

CREATE TABLE BORROWER (
  CNAME VARCHAR(20),
  LNO INT,
  PRIMARY KEY (CNAME, LNO),
  FOREIGN KEY (CNAME) REFERENCES CUST(CNAME) ON DELETE CASCADE,
  FOREIGN KEY (LNO) REFERENCES LOAN(LNO) ON DELETE CASCADE
);

-- STEP 3: Minimal Data Insertion

-- Branches
INSERT INTO BRANCH VALUES ('MAIN', 'BLR', 2500000);
INSERT INTO BRANCH VALUES ('BLRSUB1', 'BLR', 1000000);
INSERT INTO BRANCH VALUES ('MANDYA', 'MANDYA', 1000000);

-- Accounts
INSERT INTO ACCOUNT VALUES (1, 'MAIN', 5000);
INSERT INTO ACCOUNT VALUES (2, 'MAIN', 6000);
INSERT INTO ACCOUNT VALUES (3, 'MAIN', 7000);
INSERT INTO ACCOUNT VALUES (4, 'BLRSUB1', 8000);
INSERT INTO ACCOUNT VALUES (5, 'MANDYA', 10000);
INSERT INTO ACCOUNT VALUES (6, 'MANDYA', 11000);

-- Customers
INSERT INTO CUST VALUES ('STAN', 'BAKER ST', 'BLR');
INSERT INTO CUST VALUES ('ERIC', 'ROBIN RD', 'BLR');

-- Depositors
-- STAN has 2 accounts in MAIN
INSERT INTO DEPOSITOR VALUES ('STAN', 1);
INSERT INTO DEPOSITOR VALUES ('STAN', 2);

-- ERIC has accounts in both MAIN and BLRSUB1 (city = BLR)
INSERT INTO DEPOSITOR VALUES ('ERIC', 3);
INSERT INTO DEPOSITOR VALUES ('ERIC', 4);

-- STAN has 2 accounts in MANDYA
INSERT INTO DEPOSITOR VALUES ('STAN', 5);
INSERT INTO DEPOSITOR VALUES ('STAN', 6);

-- Loan & Borrower (just 1 for integrity)
INSERT INTO LOAN VALUES (101, 'MAIN', 50000);
INSERT INTO BORROWER VALUES ('STAN', 101);

-- STEP 4: Queries

-- Query 1: Customers with at least two accounts at MAIN branch
SELECT D.CNAME
FROM DEPOSITOR D
JOIN ACCOUNT A ON D.ACCNO = A.ACCNO
WHERE A.BNAME = 'MAIN'
GROUP BY D.CNAME
HAVING COUNT(*) >= 2;

-- Query 2: Customers who have accounts in all branches in city 'BLR'
SELECT D.CNAME
FROM DEPOSITOR D
JOIN ACCOUNT A ON D.ACCNO = A.ACCNO
JOIN BRANCH B ON A.BNAME = B.BNAME
WHERE B.CITY = 'BLR'
GROUP BY D.CNAME
HAVING COUNT(DISTINCT B.BNAME) = (
  SELECT COUNT(*) FROM BRANCH WHERE CITY = 'BLR'
);

-- Query 3: Delete all accounts in branches located in 'BLR' (fixed to avoid ERROR 1093)
DELETE FROM ACCOUNT
WHERE ACCNO IN (
  SELECT accno FROM (
    SELECT A.ACCNO
    FROM ACCOUNT A
    JOIN BRANCH B ON A.BNAME = B.BNAME
    WHERE B.CITY = 'BLR'
  ) AS temp
);

-- Show remaining accounts after deletion
SELECT * FROM ACCOUNT;
